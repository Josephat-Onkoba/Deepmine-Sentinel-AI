{% extends "core/base.html" %}

{% block title %}Batch Predictions{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <span class="mr-2">ðŸ”®</span>
            Batch Stability Predictions
        </h1>
        <p class="text-gray-600">Generate AI predictions for multiple stopes at once</p>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-4 rounded-md 
                {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-700
                {% elif message.tags == 'warning' %}bg-yellow-50 border border-yellow-200 text-yellow-700
                {% elif message.tags == 'success' %}bg-green-50 border border-green-200 text-green-700
                {% else %}bg-blue-50 border border-blue-200 text-blue-700{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="bg-white rounded-lg shadow">
        <form method="post" class="p-6">
            {% csrf_token %}
            
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-medium text-gray-900">Select Stopes for Prediction</h2>
                    <div class="space-x-2">
                        <button type="button" onclick="selectAll()" 
                                class="text-sm text-blue-600 hover:text-blue-800">
                            Select All
                        </button>
                        <button type="button" onclick="selectNone()" 
                                class="text-sm text-gray-600 hover:text-gray-800">
                            Select None
                        </button>
                    </div>
                </div>
                
                {% if stopes %}
                    <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-md">
                        <div class="grid grid-cols-1 divide-y divide-gray-200">
                            {% for stope in stopes %}
                                <label class="flex items-center p-4 hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" name="stope_ids" value="{{ stope.id }}" 
                                           class="stope-checkbox h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                                    <div class="ml-3 flex-1">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h3 class="text-sm font-medium text-gray-900">{{ stope.stope_name }}</h3>
                                                <p class="text-xs text-gray-500">
                                                    {{ stope.rock_type }} | Depth: {{ stope.depth }}m | RQD: {{ stope.rqd }}%
                                                </p>
                                            </div>
                                            <div class="text-xs text-gray-400">
                                                Created: {{ stope.created_at|date:"M d, Y" }}
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2 2v-5m16 0h-2M4 13h2m13 0h-2M4 13l2-2m0 0l2 2m-2-2v2m13-2l-2-2m0 0l-2 2m2-2v2" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No stopes available</h3>
                        <p class="mt-1 text-sm text-gray-500">Create some stopes first to generate predictions.</p>
                        <div class="mt-6">
                            <a href="{% url 'stope_create' %}" 
                               class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                <svg class="-ml-1 mr-2 h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                Create New Stope
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>

            {% if stopes %}
                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                    <div class="text-sm text-gray-600">
                        <span id="selected-count">0</span> of {{ stopes.count }} stopes selected
                    </div>
                    
                    <div class="space-x-3">
                        <a href="{% url 'ml_dashboard' %}" 
                           class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                            Cancel
                        </a>
                        <button type="submit" 
                                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed" 
                                id="submit-btn" disabled>
                            Generate Predictions
                        </button>
                    </div>
                </div>
            {% endif %}
        </form>
    </div>

    <!-- Help Section -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-medium text-blue-900 mb-2">How Batch Predictions Work</h3>
        <div class="text-sm text-blue-800 space-y-2">
            <p>â€¢ Select multiple stopes from the list above</p>
            <p>â€¢ Our AI model will analyze each stope's features and time series data</p>
            <p>â€¢ Predictions will be generated for stability risk levels: Stable, Elevated Risk, High Risk, Unstable</p>
            <p>â€¢ Results will be saved to the database and displayed on the next page</p>
            <p>â€¢ You can provide feedback on predictions to help improve the model</p>
        </div>
    </div>
</div>

<script>
function selectAll() {
    document.querySelectorAll('.stope-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

function selectNone() {
    document.querySelectorAll('.stope-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkedBoxes = document.querySelectorAll('.stope-checkbox:checked');
    const count = checkedBoxes.length;
    
    document.getElementById('selected-count').textContent = count;
    document.getElementById('submit-btn').disabled = count === 0;
}

// Add event listeners to checkboxes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.stope-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    updateSelectedCount(); // Initial count
});
</script>

{% endblock %}
