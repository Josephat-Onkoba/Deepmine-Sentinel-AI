<!-- core/templates/stope/stope_form.html -->
{% extends "core/base.html" %}

{% block title %}Add Stope{% endblock %}

{% block content %}
<div class="main-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="flex items-center space-x-4">
        <div class="icon-circle bg-primary-light">
          <span class="material-icons">add_location</span>
        </div>
        <div>
          <h1 class="page-title">Add New Stope</h1>
          <p class="page-subtitle">Enter geological and structural details for the stope</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %} mb-6">
        <span class="material-icons">
          {% if message.tags == 'error' %}error
          {% elif message.tags == 'success' %}check_circle
          {% else %}info
          {% endif %}
        </span>
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <div class="max-w-4xl mx-auto">
    <form method="POST" class="card">
      {% csrf_token %}
      
      <div class="card-header">
        <h2 class="card-title">
          <span class="material-icons">info</span>
          Stope Information
        </h2>
      </div>
      
      <div class="card-body space-y-8">
        <!-- Basic Information -->
        <div class="form-section">
          <h3 class="form-section-title">Basic Information</h3>
          <div class="form-grid grid-cols-2">
            <div class="form-group">
              <label for="{{ form.stope_name.id_for_label }}" class="form-label required">
                Stope Name
              </label>
              {{ form.stope_name }}
              {% if form.stope_name.help_text %}
                <p class="form-help">{{ form.stope_name.help_text }}</p>
              {% endif %}
              {% if form.stope_name.errors %}
                <p class="form-error">{{ form.stope_name.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.rock_type.id_for_label }}" class="form-label required">
                Rock Type
              </label>
              {{ form.rock_type }}
              {% if form.rock_type.help_text %}
                <p class="form-help">{{ form.rock_type.help_text }}</p>
              {% endif %}
              {% if form.rock_type.errors %}
                <p class="form-error">{{ form.rock_type.errors.0 }}</p>
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Geological Parameters -->
        <div class="form-section">
          <h3 class="form-section-title">Geological Parameters</h3>
          <div class="form-grid grid-cols-3">
            <div class="form-group">
              <label for="{{ form.rqd.id_for_label }}" class="form-label required">
                RQD (%)
              </label>
              {{ form.rqd }}
              {% if form.rqd.help_text %}
                <p class="form-help">{{ form.rqd.help_text }}</p>
              {% endif %}
              {% if form.rqd.errors %}
                <p class="form-error">{{ form.rqd.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.depth.id_for_label }}" class="form-label required">
                Depth (m)
              </label>
              {{ form.depth }}
              {% if form.depth.help_text %}
                <p class="form-help">{{ form.depth.help_text }}</p>
              {% endif %}
              {% if form.depth.errors %}
                <p class="form-error">{{ form.depth.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.dip.id_for_label }}" class="form-label required">
                Dip (Â°)
              </label>
              {{ form.dip }}
              {% if form.dip.help_text %}
                <p class="form-help">{{ form.dip.help_text }}</p>
              {% endif %}
              {% if form.dip.errors %}
                <p class="form-error">{{ form.dip.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.direction.id_for_label }}" class="form-label required">
                Direction
              </label>
              {{ form.direction }}
              {% if form.direction.help_text %}
                <p class="form-help">{{ form.direction.help_text }}</p>
              {% endif %}
              {% if form.direction.errors %}
                <p class="form-error">{{ form.direction.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.hr.id_for_label }}" class="form-label required">
                Hydraulic Radius
              </label>
              {{ form.hr }}
              {% if form.hr.help_text %}
                <p class="form-help">{{ form.hr.help_text }}</p>
              {% endif %}
              {% if form.hr.errors %}
                <p class="form-error">{{ form.hr.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.undercut_wdt.id_for_label }}" class="form-label required">
                Undercut Width (m)
              </label>
              {{ form.undercut_wdt }}
              {% if form.undercut_wdt.help_text %}
                <p class="form-help">{{ form.undercut_wdt.help_text }}</p>
              {% endif %}
              {% if form.undercut_wdt.errors %}
                <p class="form-error">{{ form.undercut_wdt.errors.0 }}</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Support System -->
        <div class="form-section">
          <h3 class="form-section-title">Support System</h3>
          <div class="form-grid grid-cols-3">
            <div class="form-group">
              <label for="{{ form.support_type.id_for_label }}" class="form-label required">
                Support Type
              </label>
              {{ form.support_type }}
              {% if form.support_type.help_text %}
                <p class="form-help">{{ form.support_type.help_text }}</p>
              {% endif %}
              {% if form.support_type.errors %}
                <p class="form-error">{{ form.support_type.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.support_density.id_for_label }}" class="form-label required">
                Support Density
              </label>
              {{ form.support_density }}
              {% if form.support_density.help_text %}
                <p class="form-help">{{ form.support_density.help_text }}</p>
              {% endif %}
              {% if form.support_density.errors %}
                <p class="form-error">{{ form.support_density.errors.0 }}</p>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.support_installed.id_for_label }}" class="form-label">
                Support Installed
              </label>
              <div class="checkbox-wrapper">
                {{ form.support_installed }}
                <span class="checkbox-label">Yes, support is installed</span>
              </div>
              {% if form.support_installed.help_text %}
                <p class="form-help">{{ form.support_installed.help_text }}</p>
              {% endif %}
              {% if form.support_installed.errors %}
                <p class="form-error">{{ form.support_installed.errors.0 }}</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary btn-lg">
            <span class="material-icons">save</span>
            Save Stope
          </button>
          <a href="{% url 'stope_list' %}" class="btn btn-secondary btn-lg">
            <span class="material-icons">cancel</span>
            Cancel
          </a>
        </div>
      </div>
    </form>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const supportTypeField = document.getElementById('{{ form.support_type.id_for_label }}');
    const supportDensityField = document.getElementById('{{ form.support_density.id_for_label }}');
    const supportInstalledField = document.getElementById('{{ form.support_installed.id_for_label }}');
    const supportDensityContainer = supportDensityField.closest('.form-group');
    
    function updateSupportFields() {
        const selectedSupportType = supportTypeField.value;
        
        if (selectedSupportType === 'None' || selectedSupportType === '') {
            // Support type is None - make support density optional and uncheck support installed
            supportDensityField.removeAttribute('required');
            supportDensityField.value = '';
            supportDensityField.disabled = true;
            supportDensityField.style.backgroundColor = 'var(--gray-100)';
            supportDensityField.style.cursor = 'not-allowed';
            
            supportInstalledField.checked = false;
            supportInstalledField.disabled = true;
            
            // Update visual indicators
            const label = supportDensityContainer.querySelector('.form-label');
            if (label) {
                label.classList.remove('required');
                
                // Add optional text
                let optionalText = label.querySelector('.optional-text');
                if (!optionalText) {
                    optionalText = document.createElement('span');
                    optionalText.className = 'optional-text text-gray-500 text-sm ml-2';
                    optionalText.textContent = '(optional when no support)';
                    label.appendChild(optionalText);
                }
            }
            
        } else {
            // Support type is selected - make support density required and check support installed
            supportDensityField.setAttribute('required', 'required');
            supportDensityField.disabled = false;
            supportDensityField.style.backgroundColor = '';
            supportDensityField.style.cursor = '';
            
            supportInstalledField.checked = true;
            supportInstalledField.disabled = false;
            
            // Update visual indicators
            const label = supportDensityContainer.querySelector('.form-label');
            if (label) {
                label.classList.add('required');
                
                // Remove optional text
                const optionalText = label.querySelector('.optional-text');
                if (optionalText) {
                    optionalText.remove();
                }
            }
        }
    }
    
    // Run on page load to set initial state
    updateSupportFields();
    
    // Run when support type changes
    supportTypeField.addEventListener('change', updateSupportFields);
});
</script>
{% endblock %}
