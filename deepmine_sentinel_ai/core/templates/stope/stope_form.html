<!-- core/templates/stope/stope_form.html -->
{% extends "core/base.html" %}

{% block title %}Add Stope{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
  <h1 class="text-3xl font-bold text-gray-900 mb-6">Enter Stope Details</h1>
  
  {% if messages %}
    {% for message in messages %}
      <div class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <form method="POST" class="bg-white p-8 rounded-lg shadow-lg space-y-6">
    {% csrf_token %}
    
    <!-- Basic Information -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="{{ form.stope_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          Stope Name <span class="text-red-500">*</span>
        </label>
        {{ form.stope_name }}
        {% if form.stope_name.help_text %}
          <p class="mt-1 text-sm text-gray-500">{{ form.stope_name.help_text }}</p>
        {% endif %}
        {% if form.stope_name.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.stope_name.errors.0 }}</p>
        {% endif %}
      </div>

      <div>
        <label for="{{ form.rock_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          Rock Type <span class="text-red-500">*</span>
        </label>
        {{ form.rock_type }}
        {% if form.rock_type.help_text %}
          <p class="mt-1 text-sm text-gray-500">{{ form.rock_type.help_text }}</p>
        {% endif %}
        {% if form.rock_type.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.rock_type.errors.0 }}</p>
        {% endif %}
      </div>
    </div>

    <!-- Geological Parameters -->
    <fieldset class="border border-gray-200 rounded-lg p-4">
      <legend class="text-lg font-medium text-gray-900 px-2">Geological Parameters</legend>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div>
          <label for="{{ form.rqd.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            RQD (%) <span class="text-red-500">*</span>
          </label>
          {{ form.rqd }}
          {% if form.rqd.help_text %}
            <p class="mt-1 text-sm text-gray-500">{{ form.rqd.help_text }}</p>
          {% endif %}
          {% if form.rqd.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.rqd.errors.0 }}</p>
          {% endif %}
        </div>

        <div>
          <label for="{{ form.depth.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            Depth (m) <span class="text-red-500">*</span>
          </label>
          {{ form.depth }}
          {% if form.depth.help_text %}
            <p class="mt-1 text-sm text-gray-500">{{ form.depth.help_text }}</p>
          {% endif %}
          {% if form.depth.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.depth.errors.0 }}</p>
          {% endif %}
        </div>

        <div>
          <label for="{{ form.dip.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            Dip (Â°) <span class="text-red-500">*</span>
          </label>
          {{ form.dip }}
          {% if form.dip.help_text %}
            <p class="mt-1 text-sm text-gray-500">{{ form.dip.help_text }}</p>
          {% endif %}
          {% if form.dip.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.dip.errors.0 }}</p>
          {% endif %}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div>
          <label for="{{ form.direction.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            Direction <span class="text-red-500">*</span>
          </label>
          {{ form.direction }}
          {% if form.direction.help_text %}
            <p class="mt-1 text-sm text-gray-500">{{ form.direction.help_text }}</p>
          {% endif %}
          {% if form.direction.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.direction.errors.0 }}</p>
          {% endif %}
        </div>

        <div>
          <label for="{{ form.hr.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            Hydraulic Radius <span class="text-red-500">*</span>
          </label>
          {{ form.hr }}
          {% if form.hr.help_text %}
            <p class="mt-1 text-sm text-gray-500">{{ form.hr.help_text }}</p>
          {% endif %}
          {% if form.hr.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.hr.errors.0 }}</p>
          {% endif %}
        </div>

        <div>
          <label for="{{ form.undercut_wdt.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            Undercut Width (m) <span class="text-red-500">*</span>
          </label>
          {{ form.undercut_wdt }}
          {% if form.undercut_wdt.help_text %}
            <p class="mt-1 text-sm text-gray-500">{{ form.undercut_wdt.help_text }}</p>
          {% endif %}
          {% if form.undercut_wdt.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.undercut_wdt.errors.0 }}</p>
          {% endif %}
        </div>
      </div>
    </fieldset>

    <!-- Support System -->
    <fieldset class="border border-gray-200 rounded-lg p-4">
      <legend class="text-lg font-medium text-gray-900 px-2">Support System</legend>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div>
          <label for="{{ form.support_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            Support Type <span class="text-red-500">*</span>
          </label>
          {{ form.support_type }}
          {% if form.support_type.help_text %}
            <p class="mt-1 text-sm text-gray-500">{{ form.support_type.help_text }}</p>
          {% endif %}
          {% if form.support_type.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.support_type.errors.0 }}</p>
          {% endif %}
        </div>

        <div>
          <label for="{{ form.support_density.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
            Support Density <span class="text-red-500">*</span>
          </label>
          {{ form.support_density }}
          {% if form.support_density.help_text %}
            <p class="mt-1 text-sm text-gray-500">{{ form.support_density.help_text }}</p>
          {% endif %}
          {% if form.support_density.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.support_density.errors.0 }}</p>
          {% endif %}
        </div>

        <div class="flex items-center mt-6">
          {{ form.support_installed }}
          <label for="{{ form.support_installed.id_for_label }}" class="ml-2 text-sm font-medium text-gray-700">
            Support Installed
          </label>
          {% if form.support_installed.errors %}
            <p class="mt-1 text-sm text-red-600">{{ form.support_installed.errors.0 }}</p>
          {% endif %}
        </div>
      </div>
    </fieldset>

    <!-- Submit Button -->
    <div class="flex justify-end space-x-4">
      <a href="{% url 'home' %}" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
        Cancel
      </a>
      <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
        Create Stope
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const supportTypeField = document.getElementById('{{ form.support_type.id_for_label }}');
    const supportDensityField = document.getElementById('{{ form.support_density.id_for_label }}');
    const supportInstalledField = document.getElementById('{{ form.support_installed.id_for_label }}');
    const supportDensityContainer = supportDensityField.closest('div');
    
    function updateSupportFields() {
        const selectedSupportType = supportTypeField.value;
        
        if (selectedSupportType === 'None' || selectedSupportType === '') {
            // Support type is None - make support density optional and uncheck support installed
            supportDensityField.removeAttribute('required');
            supportDensityField.value = '';
            supportDensityField.disabled = true;
            supportDensityField.style.backgroundColor = '#f3f4f6';
            supportDensityField.style.cursor = 'not-allowed';
            
            supportInstalledField.checked = false;
            supportInstalledField.disabled = true;
            
            // Update visual indicators - hide required asterisk
            const supportDensityLabel = supportDensityContainer.querySelector('label');
            if (supportDensityLabel) {
                const requiredSpan = supportDensityLabel.querySelector('.text-red-500');
                if (requiredSpan) {
                    requiredSpan.style.display = 'none';
                }
                
                // Add optional text
                let optionalText = supportDensityLabel.querySelector('.optional-text');
                if (!optionalText) {
                    optionalText = document.createElement('span');
                    optionalText.className = 'optional-text text-gray-500 text-sm ml-1';
                    optionalText.textContent = '(optional when no support)';
                    supportDensityLabel.appendChild(optionalText);
                }
            }
            
        } else {
            // Support type is selected - make support density required and check support installed
            supportDensityField.setAttribute('required', 'required');
            supportDensityField.disabled = false;
            supportDensityField.style.backgroundColor = '';
            supportDensityField.style.cursor = '';
            
            supportInstalledField.checked = true;
            supportInstalledField.disabled = false;
            
            // Update visual indicators - show required asterisk
            const supportDensityLabel = supportDensityContainer.querySelector('label');
            if (supportDensityLabel) {
                const requiredSpan = supportDensityLabel.querySelector('.text-red-500');
                if (requiredSpan) {
                    requiredSpan.style.display = 'inline';
                }
                
                // Remove optional text
                const optionalText = supportDensityLabel.querySelector('.optional-text');
                if (optionalText) {
                    optionalText.remove();
                }
            }
        }
    }
    
    // Run on page load to set initial state
    updateSupportFields();
    
    // Run when support type changes
    supportTypeField.addEventListener('change', updateSupportFields);
});
</script>

<style>
  .form-control {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }
  .form-control:focus {
    outline: none;
    box-shadow: 0 0 0 2px #3b82f6;
    border-color: #3b82f6;
  }
  .form-check-input {
    height: 1rem;
    width: 1rem;
    color: #3b82f6;
    border-radius: 0.25rem;
    border: 1px solid #d1d5db;
  }
  .form-check-input:focus {
    box-shadow: 0 0 0 2px #3b82f6;
  }
</style>
{% endblock %}
